<!DOCTYPE html>
<html>
  <head>
    <meta name="viewport" content="width=device-width" />

    <style>
      body { font-family: Tahoma, Geneva, sans-serif; text-align: center; }
    </style>

    <script type="text/javascript" src="https://raw.githack.com/colyseus/colyseus.js/master/dist/colyseus.js"></script>

    <style type="text/css">
        .player {
            width: 100px;
            height: 100px;
            position: absolute;
            z-index: -2;
            border-radius: 50%;
            border: 5px solid black;
            padding-top: 24px;
            box-sizing: border-box;
            left: 0;
            top: 0;
        }
        .obstacle {
            position: absolute;
            z-index: -1;
        }
        #nameArea {
            display: flex;
            position: relative;
            z-index: 0;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            text-align: center;
            min-height: 100vh;
        }
        #nameInput {
            width: 30%;
            border: none;
            border-bottom: 2px solid black;
            font-size: 20px;
            outline: 0;
            text-align: center;
            background: none;
        }
        #colourButton {
            width: 100px;
            height: 100px;
            margin-top: 1%;
            border-radius: 50%;
            border: 5px solid black;
        }
        body {
            overflow: hidden;
            background-position: 0px 0px;
            background-repeat: repeat;
            background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAASwAAAEsCAYAAAB5fY51AAAACXBIWXMAABYlAAAWJQFJUiTwAAAFHGlUWHRYTUw6Y29tLmFkb2JlLnhtcAAAAAAAPD94cGFja2V0IGJlZ2luPSLvu78iIGlkPSJXNU0wTXBDZWhpSHpyZVN6TlRjemtjOWQiPz4gPHg6eG1wbWV0YSB4bWxuczp4PSJhZG9iZTpuczptZXRhLyIgeDp4bXB0az0iQWRvYmUgWE1QIENvcmUgNS42LWMxNDUgNzkuMTYzNDk5LCAyMDE4LzA4LzEzLTE2OjQwOjIyICAgICAgICAiPiA8cmRmOlJERiB4bWxuczpyZGY9Imh0dHA6Ly93d3cudzMub3JnLzE5OTkvMDIvMjItcmRmLXN5bnRheC1ucyMiPiA8cmRmOkRlc2NyaXB0aW9uIHJkZjphYm91dD0iIiB4bWxuczp4bXA9Imh0dHA6Ly9ucy5hZG9iZS5jb20veGFwLzEuMC8iIHhtbG5zOmRjPSJodHRwOi8vcHVybC5vcmcvZGMvZWxlbWVudHMvMS4xLyIgeG1sbnM6cGhvdG9zaG9wPSJodHRwOi8vbnMuYWRvYmUuY29tL3Bob3Rvc2hvcC8xLjAvIiB4bWxuczp4bXBNTT0iaHR0cDovL25zLmFkb2JlLmNvbS94YXAvMS4wL21tLyIgeG1sbnM6c3RFdnQ9Imh0dHA6Ly9ucy5hZG9iZS5jb20veGFwLzEuMC9zVHlwZS9SZXNvdXJjZUV2ZW50IyIgeG1wOkNyZWF0b3JUb29sPSJBZG9iZSBQaG90b3Nob3AgQ0MgMjAxOSAoV2luZG93cykiIHhtcDpDcmVhdGVEYXRlPSIyMDE5LTA5LTE3VDExOjEzOjIxKzAxOjAwIiB4bXA6TW9kaWZ5RGF0ZT0iMjAxOS0wOS0xN1QxMjoxMToyNiswMTowMCIgeG1wOk1ldGFkYXRhRGF0ZT0iMjAxOS0wOS0xN1QxMjoxMToyNiswMTowMCIgZGM6Zm9ybWF0PSJpbWFnZS9wbmciIHBob3Rvc2hvcDpDb2xvck1vZGU9IjMiIHBob3Rvc2hvcDpJQ0NQcm9maWxlPSJzUkdCIElFQzYxOTY2LTIuMSIgeG1wTU06SW5zdGFuY2VJRD0ieG1wLmlpZDoyOTRiOTZhOS05YWM4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');
        }
    </style>
    <script src="res/jscolor.js"></script>
    <script>
        currentColour = Math.random().toString(16).slice(2, 8);
    </script>
  </head>
  <body style="background-color: white;">
      <div id="nameArea">
          <input id="nameInput" value="Enter a name" onclick="if (this.value == 'Enter a name') {this.value = ''}" onblur="if (this.value == '') {this.value = 'Enter a name'}" maxlength="16">
          <button id="colourButton" class="jscolor{valueElement:null, value: currentColour, onFineChange:'colourChanged(this.toString())'}">
              <b style="font-family: Tahoma, Geneva, sans-serif; pointer-events: none; vertical-align: middle; text-align: center;">Pick a Colour!</b>
          </button>
      </div>
      <div style="float: left; position: fixed; bottom: 5px; left: 5px; width: 30%;" id="chatArea" hidden=true>
          <p id="chat" style="text-align: left; text-overflow: clip; word-wrap: break-word; height: 30%;"></p>
          <input type="text" style="width: 100%;" id="chatInput">
      </div>
    <script>
        document.body.style.height = window.innerHeight;
        document.body.style.width = window.innerWidth;

        running = 0;

        let host = window.document.location.host.replace(/:.*/, '');

        let client = new Colyseus.Client(location.protocol.replace("http", "ws") + "//" + host + (location.port ? ':' + location.port : ''));
        let room;

        startGame = function(name) {
            running = 1;
            this.name = name;
            document.getElementById("chatArea").hidden = false;
            client.joinOrCreate("Game", {name: this.name, colour: currentColour}).then(room_instance => {
                let room = room_instance

                let players = {};
                let obstacles = {};

                let uniOffset = 50;

                currentId = room.sessionId;

                cameraPosition = {
                    x: window.innerWidth / 2,
                    y: window.innerHeight / 2
                };

                room.state.obstacles.onAdd = function (obstacle, id) {
                    let dom = document.createElement("div");
                    dom.className = "obstacle";
                    dom.style.background = obstacle.colour;
                    dom.style.top = obstacle.y + "px";
                    dom.style.left = obstacle.y + "px";
                    dom.style.width = obstacle.w + "px";
                    dom.style.height = obstacle.h + "px";
                    obstacles[id] = {
                        obstacle: obstacle,
                        dom: dom
                    };
                    document.body.appendChild(obstacles[id].dom);
                }

                room.state.players.onAdd = function (player, sessionId) {
                    let dom = document.createElement("div");
                    dom.className = "player";
                    dom.innerHTML = "<b style='vertical-align: middle; text-align: center; word-wrap: break-word;'>" + player.name + "</b>";
                    dom.style.background = player.colour;
                    if (document.body.style.backgroundColor == "white") {
                        dom.style.border = "5px solid black";
                    } else {
                        dom.style.border = "5px solid lightgrey";
                    }

                    players[sessionId] = {
                        player: player,
                        dom: dom
                    };

                    document.body.appendChild(players[sessionId].dom);

                    for (let playerSessionId in players) {
                        renderPlayer(playerSessionId);
                    }
                }

                room.state.players.onRemove = function (player, sessionId) {
                    document.body.removeChild(players[sessionId].dom);
                    delete players[sessionId];
                }

                room.state.players.onChange = function (player, sessionId) {
                    moveCamera();
                    for (let playerSessionId in players) {
                        renderPlayer(playerSessionId);
                    }
                    for (let obstacleId in obstacles) {
                        renderObstacle(obstacleId);
                    }
                }

                room.onMessage((message) => {
                    document.getElementById("chat").innerHTML += "<br>" + message;
                    room.state.players.onChange();
                });

                let renderPlayer = function(sessionId) {
                    let dom = players[sessionId].dom;
                    let player = players[sessionId].player;
                    try {
                        dom.innerHTML = "<b style='vertical-align: middle; text-align: center; word-wrap: break-word;'>" + players[sessionId].player.name + "</b>";
                    } catch {
                        dom.innerHTML = "Player";
                    }
                    if(player.x >= cameraPosition.x - uniOffset && player.x <= (cameraPosition.x + window.innerWidth) + uniOffset && player.y >= cameraPosition.y - uniOffset && player.y <= (cameraPosition.y + window.innerHeight) + uniOffset) {
                        let offset = {
                            x: player.x - cameraPosition.x,
                            y: player.y - cameraPosition.y
                        };
                        dom.hidden = false;
                        dom.style.left = (offset.x - uniOffset) + "px";
                        dom.style.top = (offset.y - uniOffset) + "px";
                    } else {
                        dom.hidden = true;
                    }
                }

                let renderObstacle = function(id) {
                    let dom = obstacles[id].dom;
                    let obstacle = obstacles[id].obstacle;
                    let offset = {
                        x: obstacle.x - cameraPosition.x,
                        y: obstacle.y - cameraPosition.y
                    };
                    dom.style.left = (offset.x - uniOffset) + "px";
                    dom.style.top = (offset.y - uniOffset) + "px";
                }

                let moveCamera = function() {
                    cameraPosition = {
                        x: players[currentId].player.x - window.innerWidth / 2,
                        y: players[currentId].player.y - window.innerHeight / 2
                    };

                    document.body.style.backgroundPosition = ((-cameraPosition.x) + "px " + (-cameraPosition.y) + "px");
                }

                let sendMessage = function() {
                    document.getElementById("chatInput").blur();
                    if (room.state.players[currentId].name == "") {
                        message = "Player" + ": " + document.getElementById("chatInput").value;
                    } else {
                        message = room.state.players[currentId].name + ": " + document.getElementById("chatInput").value;
                    }
                    document.getElementById("chatInput").value = "";
                    room.send({id: "Message", data: message});
                }

                window.addEventListener("keydown", function (e) {
                    if (document.getElementById("chatInput") != document.activeElement)
                    room.send({id: "KeyDown", data:{key: e.which}});

                    if (e.which == 32 && document.getElementById("chatInput") != document.activeElement && document.getElementById("nameInput") != document.activeElement) {
                        if (document.body.style.backgroundColor == "white") {
                            document.body.style.backgroundColor = "black";
                            divs = document.getElementsByClassName('player');
                            for (i = 0; i != divs.length; i++) {
                                divs[i].style.border = "5px solid White";
                                divs[i].style.color = "White";
                            }
                            divs = document.getElementsByClassName('obstacle');
                            for (i = 0; i != divs.length; i++) {
                                divs[i].style.background = "White";
                            }
                        } else {
                            document.body.style.backgroundColor = "white";
                            divs = document.getElementsByClassName('player');
                            for (i = 0; i != divs.length; i++) {
                                divs[i].style.border = "5px solid black";
                                divs[i].style.color = "black";
                            }
                            divs = document.getElementsByClassName('obstacle');
                            for (i = 0; i != divs.length; i++) {
                                divs[i].style.background = "black";
                            }
                        }
                    } if (e.which == 13 && document.getElementById("chatInput").value != "" && document.getElementById("chatInput") == document.activeElement) {
                        sendMessage();
                    }
                });

                window.addEventListener("keyup", function(e) {
                    room.send({id: "KeyUp", data:{key: e.which}});
                });

                window.addEventListener('resize', room.state.players.onChange);

            });
        }

        window.addEventListener("keydown", function (e) {
            if (!running && e.which == 13) {
                name = document.getElementById("nameInput").value;
                if (name == "Enter a name")
                name = ""
                document.getElementById("nameInput").remove();
                document.getElementById("colourButton").remove();
                startGame(name, currentColour);
            }
        });

        colourChanged = function(colour) {
            currentColour = colour;
        }
    </script>
  </body>
</html>
